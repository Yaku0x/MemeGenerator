<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TheyLied Meme Maker — Simple Desktop (Working)</title>
<style>
  :root{ --bg:#0f0f10; --panel:#16171a; --ink:#e9e9ea; --brand:#ca3028; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .app{display:grid; grid-template-rows:auto 1fr; height:100%}
  /* Top bar */
  .top{display:flex; align-items:center; gap:10px; padding:10px 14px; background:#111214; border-bottom:1px solid #23252a}
  .top .btn{background:#23252a;border:1px solid #2f3238;color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer}
  .top select{background:#23252a;border:1px solid #2f3238;color:var(--ink);padding:10px;border-radius:10px}
  .top .sp{flex:1}

  /* Work area */
  .work{display:grid; grid-template-columns: 300px 1fr; height:100%}
  .side{background:var(--panel); border-right:1px solid #23252a; padding:12px; overflow:auto}
  .side h3{margin:6px 0 10px; font-size:14px; opacity:.9}
  .side .group{display:grid; gap:8px; margin-bottom:14px}
  .side .btn{background:#23252a;border:1px solid #2f3238;color:var(--ink);padding:10px;border-radius:10px;cursor:pointer;width:100%}
  .muted{opacity:.7; font-size:12px}

  /* Canvas */
  #stageWrap{display:grid; place-items:center; padding:14px}
  #stage{position:relative; width:1600px; height:900px; background:#f7f7f8; box-shadow:0 20px 60px rgba(0,0,0,.5); overflow:hidden}
  .el{position:absolute; user-select:none; cursor:move;}
  .el.selected{outline:2px solid #4da3ff}
  .el img{display:block; width:100%; height:100%; object-fit:contain}
  .handle{position:absolute; right:-8px; bottom:-8px; width:14px; height:14px; background:#4da3ff; border-radius:3px; cursor:nwse-resize}

  /* Stamp appearance toggle via class */
  .stamp{display:inline-block; background:var(--brand); color:#fff; font-weight:900; padding:.18em .5em; letter-spacing:.5px}

  /* Floating text editor */
  .bubble{position:fixed; bottom:16px; right:16px; background:#141518; border:1px solid #2b2e34; border-radius:12px; padding:10px; display:flex; gap:8px; align-items:center}
  .bubble input[type=text]{width:360px; background:#1e2025; border:1px solid #2b2e34; border-radius:10px; color:var(--ink); padding:10px}
  .bubble input[type=color], .bubble input[type=number], .bubble select{background:#1e2025; border:1px solid #2b2e34; color:var(--ink); border-radius:10px; height:38px}
  .bubble .btn{padding:10px 12px}

  /* Hidden file input */
  #uploader{display:none}

  @media (max-width:1400px){ #stage{transform:scale(.75); transform-origin:top left} }
  @media (max-width:1200px){ #stage{transform:scale(.65)} }
</style>
</head>
<body>
<div class="app">
  <!-- Top toolbar -->
  <div class="top">
    <button class="btn" id="newBlank">Blank</button>
    <select id="templateSel">
      <option value="none">Choose Template…</option>
      <option value="beforeAfter">Before / After</option>
      <option value="reaction">Hoodie Reaction</option>
      <option value="lieWeek">Lie of the Week</option>
      <option value="collage">Receipts Collage (2×2)</option>
      <option value="chart">Chart Dunk</option>
      <option value="villains">Villain Board (Top 6)</option>
      <option value="stampOnly">Stamp Only</option>
    </select>
    <div class="sp"></div>
    <button class="btn" id="export">Export PNG</button>
  </div>

  <div class="work">
    <!-- Left panel -->
    <div class="side">
      <h3>Add</h3>
      <div class="group">
        <button class="btn" id="addText">Text</button>
        <button class="btn" id="addLogo">Logo</button>
        <button class="btn" id="addStamp">THEY LIED Stamp</button>
        <button class="btn" id="addMascot">Lerpy Liar</button>
        <button class="btn" id="addUpload">Upload Image (max 5)</button>
        <input id="uploader" type="file" accept="image/*" multiple>
        <div class="muted">Drag to move. Drag square to resize. Double‑click text to edit.</div>
      </div>

      <h3>Arrange</h3>
      <div class="group">
        <button class="btn" id="front">Bring Front</button>
        <button class="btn" id="back">Send Back</button>
        <button class="btn" id="dup">Duplicate</button>
        <button class="btn" id="del">Delete</button>
        <button class="btn" id="clear">Clear All</button>
      </div>

      <h3>Canvas</h3>
      <div class="group">
        <select id="sizeSel">
          <option value="1600x900">Wide 1600×900</option>
          <option value="1920x1080">HD 1920×1080</option>
          <option value="2048x1152">YouTube 2048×1152</option>
          <option value="1080x1080">Square 1080×1080</option>
        </select>
        <button class="btn" id="applySize">Apply Size</button>
        <div class="muted">Background color</div>
        <input type="color" id="bg" value="#f7f7f8" />
      </div>
    </div>

    <!-- Big canvas -->
    <div id="stageWrap">
      <div id="stage"></div>
    </div>
  </div>
</div>

<!-- Floating text editor -->
<div class="bubble" id="editor">
  <input type="text" id="txt" placeholder="Type text… (double‑click a text box first)" />
  <select id="fontFamily" title="Font">
    <option value="Impact, Arial Black, Inter, Arial, sans-serif">Impact</option>
    <option value="Anton, Impact, Arial Black, Inter, Arial, sans-serif">Anton</option>
    <option value="Arial Black, Impact, Inter, Arial, sans-serif">Arial Black</option>
    <option value="Inter, Arial, sans-serif">Inter</option>
    <option value="Arial, sans-serif">Arial</option>
  </select>
  <input type="number" id="fs" min="12" max="200" value="64" title="Font size" />
  <input type="color" id="fc" value="#000000" title="Color" />
  <button class="btn" id="stampToggle">Stamp Style</button>
</div>

<script>
// Wrap everything to ensure DOM is ready
window.addEventListener('DOMContentLoaded', () => {
  // ASSET URLS (your hosted files)
  const ASSETS = {
    logo: 'https://static.wixstatic.com/media/d7bc5f_9f109787e65c463d82461169f65dda33~mv2.png/v1/fill/w_784,h_784,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/logo_2x.png',
    stampImg: 'https://static.wixstatic.com/media/d7bc5f_e5d4a1012e8e4c46a206fb9bb975feef~mv2.png/v1/fill/w_1158,h_246,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Middel%205_2x.png',
    mascot: 'https://static.wixstatic.com/media/d7bc5f_b22bd54e2f3749f2a97dc3f85891fb0f~mv2.png/v1/crop/x_727,y_1409,w_3680,h_3739/fill/w_620,h_630,fp_0.50_0.50,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/TLL%20_2x.png'
  };

  const stage = document.getElementById('stage');
  const sizeSel = document.getElementById('sizeSel');
  const applySize = document.getElementById('applySize');
  const bg = document.getElementById('bg');
  let selected=null; let z=10; let uploadCount=0;

  // init stage
  function setSize(w,h){ stage.style.width=w+'px'; stage.style.height=h+'px'; }
  setSize(1600,900);
  stage.style.background = '#f7f7f8';

  // helpers
  function createImage(src){ const img=new Image(); img.crossOrigin='anonymous'; img.src=src; img.draggable=false; img.style.pointerEvents='none'; return img; }

  function makeEl(type, opts={}){
    const el = document.createElement('div'); el.className='el'; el.dataset.type=type; el.style.left=(opts.x||40)+'px'; el.style.top=(opts.y||40)+'px'; el.style.width=(opts.w||300)+'px'; el.style.height=(opts.h||type==='text'? 'auto':'300px'); el.style.zIndex=++z;

    if(type==='img' || type==='asset'){
      const img = createImage(opts.src); el.appendChild(img);
    } else if(type==='text'){
      const box=document.createElement('div'); box.textContent=opts.text||'YOUR TEXT'; box.style.fontWeight='900'; box.style.fontFamily=opts.font||'Impact, Arial Black, Inter, Arial, sans-serif'; box.style.fontSize=(opts.size||64)+'px'; box.style.color=opts.color||'#000'; box.style.lineHeight='1.05'; box.style.display='inline-block'; el.appendChild(box);
    }

    const handle=document.createElement('div'); handle.className='handle'; el.appendChild(handle);
    el.addEventListener('pointerdown', startDrag);
    handle.addEventListener('pointerdown', startResize);
    el.addEventListener('dblclick', () => { if(el.dataset.type==='text'){ openEditor(el); }});

    stage.appendChild(el); select(el); return el;
  }

  function select(el){ if(selected) selected.classList.remove('selected'); selected=el; if(el) el.classList.add('selected'); }

  // drag
  let dragOff=null;
  function startDrag(e){ if(e.target.classList.contains('handle')) return; const el=e.currentTarget; select(el); const r=el.getBoundingClientRect(); const s=stage.getBoundingClientRect(); dragOff={dx:e.clientX-r.left, dy:e.clientY-r.top, sx:s.left, sy:s.top}; window.addEventListener('pointermove',drag); window.addEventListener('pointerup',stopDrag); }
  function drag(e){ if(!dragOff||!selected) return; selected.style.left=(e.clientX-dragOff.sx-dragOff.dx)+'px'; selected.style.top=(e.clientY-dragOff.sy-dragOff.dy)+'px'; }
  function stopDrag(){ dragOff=null; window.removeEventListener('pointermove',drag); window.removeEventListener('pointerup',stopDrag); }

  // resize
  let res=null;
  function startResize(e){ e.stopPropagation(); if(!selected) return; const r=selected.getBoundingClientRect(); res={w:r.width,h:r.height,x:e.clientX,y:e.clientY}; window.addEventListener('pointermove',doResize); window.addEventListener('pointerup',stopResize); }
  function doResize(e){ if(!res||!selected) return; let w = Math.max(40, res.w + (e.clientX-res.x)); let h = selected.dataset.type==='text' ? 'auto' : Math.max(40, res.h + (e.clientY-res.y)); selected.style.width = w+'px'; if(h!=='auto') selected.style.height=h+'px'; }
  function stopResize(){ res=null; window.removeEventListener('pointermove',doResize); window.removeEventListener('pointerup',stopResize); }

  // editor bubble
  const editor=document.getElementById('editor'); const txt=document.getElementById('txt'); const fs=document.getElementById('fs'); const fc=document.getElementById('fc'); const fontFamily=document.getElementById('fontFamily'); const stampToggle=document.getElementById('stampToggle');
  function openEditor(el){ if(el && el.dataset.type==='text'){ txt.value=el.firstChild.textContent; fs.value=parseInt(getComputedStyle(el.firstChild).fontSize); fc.value=rgbToHex(getComputedStyle(el.firstChild).color); fontFamily.value=getComputedStyle(el.firstChild).fontFamily; }}
  function rgbToHex(rgb){ const m = rgb.match(/\d+/g); if(!m) return '#000000'; return '#' + m.slice(0,3).map(n=>('0'+parseInt(n).toString(16)).slice(-2)).join(''); }

  txt.addEventListener('input', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.textContent = txt.value; })
  fs.addEventListener('input', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.style.fontSize = fs.value+'px'; })
  fc.addEventListener('input', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.style.color = fc.value; })
  fontFamily.addEventListener('change', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.style.fontFamily = fontFamily.value; })
  stampToggle.onclick = ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.classList.toggle('stamp'); }

  // canvas settings
  document.getElementById('bg').oninput = (e)=>{ stage.style.background = e.target.value; }
  applySize.onclick = ()=>{ const [w,h]=sizeSel.value.split('x').map(Number); setSize(w,h); }

  // add buttons
  document.getElementById('addText').onclick = ()=> makeEl('text',{x:80,y:80});
  document.getElementById('addLogo').onclick = ()=> makeEl('asset',{src:ASSETS.logo,w:220});
  document.getElementById('addStamp').onclick = ()=> makeEl('asset',{src:ASSETS.stampImg,w:480});
  document.getElementById('addMascot').onclick = ()=> makeEl('asset',{src:ASSETS.mascot,w:380});

  const uploader=document.getElementById('uploader');
  document.getElementById('addUpload').onclick = ()=> uploader.click();
  uploader.onchange = (e)=>{
    const files=[...e.target.files];
    for(const file of files){ if(uploadCount>=5){ alert('Max 5 uploads reached'); break; } const url=URL.createObjectURL(file); const el=makeEl('img',{src:url,w:520}); el.dataset.upload='1'; uploadCount++; }
    uploader.value='';
  }

  // arrange
  function bringFront(){ if(selected){ selected.style.zIndex=++z; }}
  function sendBack(){ if(selected){ selected.style.zIndex=1; }}
  function duplicate(){ if(!selected) return; const c=selected.cloneNode(true); const {left,top}=selected.style; c.style.left=(parseInt(left||'0')+20)+'px'; c.style.top=(parseInt(top||'0')+20)+'px'; stage.appendChild(c); // rebind
    c.querySelector('.handle').addEventListener('pointerdown', startResize); c.addEventListener('pointerdown', startDrag); select(c); }
  function del(){ if(selected){ if(selected.dataset.upload==='1') uploadCount=Math.max(0,uploadCount-1); selected.remove(); selected=null; }}
  function clearAll(){ stage.innerHTML=''; uploadCount=0; selected=null; }

  document.getElementById('front').onclick=bringFront;
  document.getElementById('back').onclick=sendBack;
  document.getElementById('dup').onclick=duplicate;
  document.getElementById('del').onclick=del;
  document.getElementById('clear').onclick=clearAll;

  // templates
  document.getElementById('newBlank').onclick = clearAll;
  document.getElementById('templateSel').addEventListener('change', (e)=> loadTemplate(e.target.value));

  function loadTemplate(t){ clearAll();
    if(t==='beforeAfter'){
      makeEl('text',{x:60,y:40,text:'"It will never happen"',size:72});
      makeEl('img',{x:60,y:140,w:700,src:'https://via.placeholder.com/700x600?text=BEFORE'});
      makeEl('img',{x:840,y:140,w:700,src:'https://via.placeholder.com/700x600?text=AFTER'});
      makeEl('asset',{x:680,y:780,w:260,src:ASSETS.stampImg});
    } else if(t==='reaction'){
      makeEl('text',{x:80,y:80,text:'They said it was dead…',size:96});
      makeEl('asset',{x:1060,y:420,w:380,src:ASSETS.mascot});
      makeEl('asset',{x:80,y:760,w:420,src:ASSETS.stampImg});
    } else if(t==='lieWeek'){
      makeEl('asset',{x:40,y:40,w:160,src:ASSETS.logo});
      makeEl('text',{x:220,y:60,text:'LIE OF THE WEEK',size:96});
      makeEl('img',{x:300,y:220,w:1000,src:'https://via.placeholder.com/1000x520?text=Drop+Tweet+Here'});
      makeEl('asset',{x:590,y:760,w:420,src:ASSETS.stampImg});
    } else if(t==='collage'){
      makeEl('text',{x:60,y:40,text:'Receipts',size:96});
      const pos=[[60,160],[840,160],[60,520],[840,520]];
      pos.forEach(p=> makeEl('img',{x:p[0],y:p[1],w:700,src:'https://via.placeholder.com/700x300?text=Receipt'}));
      makeEl('asset',{x:640,y:760,w:320,src:ASSETS.logo});
    } else if(t==='chart'){
      makeEl('text',{x:60,y:60,text:'"Top is in" — 2023',size:80});
      makeEl('img',{x:120,y:160,w:1360,src:'https://via.placeholder.com/1360x620?text=Chart'});
      makeEl('asset',{x:620,y:760,w:360,src:ASSETS.stampImg});
    } else if(t==='villains'){
      makeEl('text',{x:60,y:40,text:'Top Liars of the Week',size:84});
      const grid=[[80,160],[590,160],[1100,160],[80,520],[590,520],[1100,520]];
      grid.forEach((p,i)=> makeEl('img',{x:p[0],y:p[1],w:420,src:`https://via.placeholder.com/420?text=#${i+1}`}));
    } else if(t==='stampOnly'){
      makeEl('asset',{x:550,y:380,w:500,src:ASSETS.stampImg});
    }
  }

  // export PNG (client-side canvas render)
  document.getElementById('export').onclick = async ()=>{
    const rect = stage.getBoundingClientRect();
    const canvas = document.createElement('canvas'); canvas.width = rect.width; canvas.height = rect.height; const ctx = canvas.getContext('2d');
    // bg
    ctx.fillStyle = getComputedStyle(stage).backgroundColor; ctx.fillRect(0,0,canvas.width,canvas.height);
    // sort by z
    const els=[...stage.querySelectorAll('.el')].sort((a,b)=> (parseInt(getComputedStyle(a).zIndex)||0)-(parseInt(getComputedStyle(b).zIndex)||0));
    for(const el of els){
      const x=parseFloat(el.style.left)||0; const y=parseFloat(el.style.top)||0; const w=el.clientWidth; const h=el.clientHeight; const type=el.dataset.type;
      if(type==='img' || type==='asset'){
        const img=el.querySelector('img'); await drawImage(ctx,img,x,y,w,h);
      } else if(type==='text'){
        const box=el.firstChild; const st=getComputedStyle(box); const isStamp=box.classList.contains('stamp');
        if(isStamp){ ctx.fillStyle=getComputedStyle(stage).getPropertyValue('--brand')||'#ca3028'; roundRect(ctx,x,y,box.offsetWidth+24,box.offsetHeight+12,8); ctx.fill(); ctx.fillStyle='#fff'; ctx.font=`900 ${parseInt(st.fontSize)}px ${st.fontFamily}`; ctx.textBaseline='top'; ctx.fillText(box.textContent, x+12, y+6); }
        else { ctx.fillStyle=st.color; ctx.font=`900 ${parseInt(st.fontSize)}px ${st.fontFamily}`; ctx.textBaseline='top'; wrapText(ctx,box.textContent,x,y,box.offsetWidth, parseInt(st.fontSize)*1.05); }
      }
    }
    try {
      const url = canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='they-lied-meme.png'; a.click();
    } catch(err){ alert('Export blocked by image host CORS. If this happens, host assets with CORS enabled or upload local images.'); }
  }

  function drawImage(ctx,img,x,y,w,h){ return new Promise(res=>{ if(img.complete) { try{ctx.drawImage(img,x,y,w,h);}catch{} res(); } else { img.onload=()=>{ try{ctx.drawImage(img,x,y,w,h);}catch{} res(); } }); }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function wrapText(ctx, text, x, y, maxWidth, lh){ const words=text.split(' '); let line=''; for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; if(ctx.measureText(test).width>maxWidth && n>0){ ctx.fillText(line,x,y); line=words[n]+' '; y+=lh; } else { line=test; } } ctx.fillText(line,x,y); }
});
</script>
</body>
</html>
