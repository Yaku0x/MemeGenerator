
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>They Lied — Meme Maker (Centered + 50% default)</title>
<style>
  :root{ --bg:#0f0f10; --panel:#16171a; --ink:#e9e9ea; --brand:#ca3028; }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial; }
  .app{ display:grid; grid-template-rows:auto 1fr; height:100% }

  /* Top bar */
  .top{ display:flex; gap:10px; align-items:center; padding:10px 14px; background:#111214; border-bottom:1px solid #23252a; position:relative }
  .btn, select, input[type=color], input[type=range]{ background:#23252a; color:var(--ink); border:1px solid #2f3238; border-radius:10px; height:36px; padding:0 10px; cursor:pointer }
  .btn{ display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; height:36px }
  .sp{ flex:1 }
  .zoom{ display:flex; align-items:center; gap:8px; position:absolute; right:14px; top:10px }
  #zoomPct{ width:70px; text-align:right; }

  /* Layout */
  .work{ display:grid; grid-template-columns: 320px 1fr; min-height:0 }
  .side{ background:var(--panel); border-right:1px solid #23252a; padding:12px; overflow:auto }
  .side h3{ margin:8px 0; font-size:14px; opacity:.9 }
  .group{ display:grid; gap:8px; margin:10px 0 16px }
  .muted{ opacity:.7; font-size:12px }

  /* Stage viewport */
  #stageViewport{ position:relative; overflow:auto; padding:32px; display:grid; place-items:center; }
  #stageScroller{ width:max-content; height:max-content; } /* container that we scale */
  #stage{ position:relative; width:1600px; height:900px; background:#f7f7f8; box-shadow:0 20px 60px rgba(0,0,0,.5); overflow:hidden; }
  .el{ position:absolute; user-select:none; cursor:move; will-change:left, top; }
  .el.selected{ outline:2px solid #4da3ff }
  .el img{ display:block; width:100%; height:100%; object-fit:contain }
  .handle{ position:absolute; right:-8px; bottom:-8px; width:14px; height:14px; background:#4da3ff; border-radius:3px; cursor:nwse-resize }
  .stamp{ display:inline-block; background:var(--brand); color:#fff; font-weight:900; padding:.18em .5em; letter-spacing:.5px }

  /* Drawing overlay */
  #drawCanvas{ position:absolute; inset:0; pointer-events:none }

  /* Editor bubble */
  .bubble{ position:fixed; bottom:16px; right:16px; background:#141518; border:1px solid #2b2e34; border-radius:12px; padding:10px; display:flex; gap:8px; align-items:center }
  .bubble input[type=text]{ width:320px; background:#1e2025; border:1px solid #2b2e34; border-radius:10px; color:var(--ink); height:36px; padding:0 10px }
</style>
</head>
<body>
<div class="app">
  <!-- Top bar -->
  <div class="top">
    <button class="btn" id="blank">Blank</button>
    <select id="tpl">
      <option value="none">Choose Template…</option>
      <option value="beforeAfter">Before / After</option>
      <option value="reaction">Hoodie Reaction</option>
      <option value="lieWeek">Lie of the Week</option>
      <option value="collage">Receipts Collage (2×2)</option>
      <option value="chart">Chart Dunk</option>
      <option value="villains">Villain Board (Top 6)</option>
      <option value="stampOnly">Stamp Only</option>
    </select>
    <div class="sp"></div>
    <div class="zoom">
      <button class="btn" id="fit">Fit</button>
      <input type="range" id="zoom" min="50" max="200" value="50">
      <div id="zoomPct">50%</div>
      <button class="btn" id="export">Export PNG</button>
    </div>
  </div>

  <div class="work">
    <!-- Sidebar -->
    <div class="side">
      <h3>Add</h3>
      <div class="group">
        <button class="btn" id="addText">Text</button>
        <button class="btn" id="addLogo">Logo</button>
        <button class="btn" id="addStamp">THEY LIED Stamp</button>
        <button class="btn" id="addMascot">Lerpy Liar</button>
        <input id="uploader" type="file" accept="image/*" multiple />
        <div class="muted">Drag to move. Drag the blue square to resize. Double‑click text to edit.</div>
      </div>

      <h3>Arrange</h3>
      <div class="group">
        <button class="btn" id="front">Bring Front</button>
        <button class="btn" id="back">Send Back</button>
        <button class="btn" id="dup">Duplicate</button>
        <button class="btn" id="del">Delete</button>
        <button class="btn" id="clear">Clear All</button>
      </div>

      <h3>Canvas</h3>
      <div class="group">
        <div>
          <select id="sizeSel">
            <option value="1600x900">Wide 1600×900</option>
            <option value="1920x1080">HD 1920×1080</option>
            <option value="2048x1152">YouTube 2048×1152</option>
            <option value="1080x1080">Square 1080×1080</option>
          </select>
          <button class="btn" id="applySize">Apply</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
          <span class="muted">BG</span> <input type="color" id="bg" value="#f7f7f8" />
        </div>
      </div>

      <h3>Draw (Paint)</h3>
      <div class="group">
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="btn" id="drawToggle">Enable Draw</button>
          <input type="color" id="brushColor" value="#000000" title="Brush color" />
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="muted">Size</span>
          <input type="range" id="brushSize" min="2" max="80" value="14" />
          <button class="btn" id="clearDraw">Clear</button>
        </div>
        <div class="muted">When drawing is enabled, paint directly on the canvas.</div>
      </div>
    </div>

    <!-- Stage viewport with padding, zoom, and centering -->
    <div id="stageViewport">
      <div id="stageScroller">
        <div id="stage">
          <canvas id="drawCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Text editor -->
<div class="bubble" id="editor">
  <input type="text" id="txt" placeholder="Type text… (double‑click a text box first)" />
  <select id="fontFamily" title="Font">
    <option value="Impact, Arial Black, Inter, Arial, sans-serif">Impact</option>
    <option value="Anton, Impact, Arial Black, Inter, Arial, sans-serif">Anton</option>
    <option value="Arial Black, Impact, Inter, Arial, sans-serif">Arial Black</option>
    <option value="Inter, Arial, sans-serif">Inter</option>
    <option value="Arial, sans-serif">Arial</option>
  </select>
  <input type="number" id="fs" min="12" max="200" value="64" title="Font size" />
  <input type="color" id="fc" value="#000000" title="Color" />
  <button class="btn" id="stampStyle">Stamp Style</button>
</div>

<script>
(function(){
  // Asset URLs
  const ASSETS = {
    logo: "https://static.wixstatic.com/media/d7bc5f_9f109787e65c463d82461169f65dda33~mv2.png/v1/fill/w_784,h_784,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/logo_2x.png",
    stampImg: "https://static.wixstatic.com/media/d7bc5f_e5d4a1012e8e4c46a206fb9bb975feef~mv2.png/v1/fill/w_1158,h_246,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Middel%205_2x.png",
    mascot: "https://static.wixstatic.com/media/d7bc5f_b22bd54e2f3749f2a97dc3f85891fb0f~mv2.png/v1/crop/x_727,y_1409,w_3680,h_3739/fill/w_620,h_630,fp_0.50_0.50,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/TLL%20_2x.png"
  };

  const stage = document.getElementById('stage');
  const scroller = document.getElementById('stageScroller');
  const viewport = document.getElementById('stageViewport');
  const drawCanvas = document.getElementById('drawCanvas');
  const dctx = drawCanvas.getContext('2d');
  let selected=null, z=10, uploadCount=0, scale=1;

  // size + background
  function setSize(w,h){
    stage.style.width=w+'px'; stage.style.height=h+'px';
    drawCanvas.width = w; drawCanvas.height = h;
  }
  setSize(1600,900);
  stage.style.background = '#f7f7f8';

  // Zoom controls (scale the scroller container, not the stage size)
  function applyZoom(newScale){
    scale = Math.max(0.5, Math.min(2, newScale));
    scroller.style.transform = `scale(${scale})`;
    scroller.style.transformOrigin = 'top left';
    document.getElementById('zoom').value = Math.round(scale*100);
    document.getElementById('zoomPct').textContent = Math.round(scale*100) + '%';
  }
  document.getElementById('zoom').addEventListener('input', (e)=> applyZoom(e.target.value/100));
  document.getElementById('fit').addEventListener('click', ()=>{
    const vw = viewport.clientWidth - 32; // padding visible
    const vh = viewport.clientHeight - 32;
    const w = stage.clientWidth, h = stage.clientHeight;
    const s = Math.max(0.5, Math.min(2, Math.min(vw/w, vh/h)));
    applyZoom(s);
  });

  // DEFAULT: 50% zoom and centered (center handled by CSS grid place-items center)
  applyZoom(0.5);

  // helpers
  function mkEl(type, opts={}){
    const el = document.createElement('div');
    el.className='el'; el.dataset.type=type;
    el.style.left=(opts.x||40)+'px'; el.style.top=(opts.y||40)+'px';
    el.style.width=(opts.w||300)+'px';
    el.style.height=(type==='text'?'auto': (opts.h||300)+'px');
    el.style.zIndex=++z;

    if(type==='img' || type==='asset'){
      const img=new Image();
      img.crossOrigin='anonymous';
      img.src = opts.src;
      img.style.width='100%'; img.style.height='100%'; img.style.display='block';
      el.appendChild(img);
    } else if(type==='text'){
      const box=document.createElement('div');
      box.textContent = opts.text || 'YOUR TEXT';
      box.style.fontWeight='900';
      box.style.fontFamily=opts.font||'Impact, Arial Black, Inter, Arial, sans-serif';
      box.style.fontSize=(opts.size||64)+'px';
      box.style.color=opts.color||'#000';
      box.style.lineHeight='1.05';
      box.style.display='inline-block';
      el.appendChild(box);
    }
    const handle=document.createElement('div'); handle.className='handle'; el.appendChild(handle);

    // events
    el.addEventListener('pointerdown', startDrag);
    handle.addEventListener('pointerdown', startResize);
    el.addEventListener('dblclick', ()=>{ if(el.dataset.type==='text'){ openEditor(el); } });

    stage.appendChild(el); select(el);
    return el;
  }
  function select(el){ if(selected) selected.classList.remove('selected'); selected=el; if(el) el.classList.add('selected'); }

  // Smooth drag via rAF throttling (zoom-aware)
  let dragOff=null, dragQueued=false, nextPos=null;
  function startDrag(e){ if(e.target.classList.contains('handle')) return;
    const el=e.currentTarget; select(el);
    const st=stage.getBoundingClientRect();
    const sx = (e.clientX - st.left)/scale;
    const sy = (e.clientY - st.top)/scale;
    dragOff={dx:sx - parseFloat(el.style.left||0), dy:sy - parseFloat(el.style.top||0)};
    window.addEventListener('pointermove', dragging);
    window.addEventListener('pointerup', stopDrag);
  }
  function dragging(e){
    if(!dragOff||!selected) return;
    const st=stage.getBoundingClientRect();
    const sx = (e.clientX - st.left)/scale;
    const sy = (e.clientY - st.top)/scale;
    nextPos = { x: sx - dragOff.dx, y: sy - dragOff.dy };
    if(!dragQueued){
      dragQueued = true;
      requestAnimationFrame(()=>{
        if(selected && nextPos){
          selected.style.left = nextPos.x + 'px';
          selected.style.top  = nextPos.y + 'px';
        }
        dragQueued=false;
      });
    }
  }
  function stopDrag(){
    dragOff=null; nextPos=null;
    window.removeEventListener('pointermove', dragging);
    window.removeEventListener('pointerup', stopDrag);
  }

  // resize
  let res=null;
  function startResize(e){ e.stopPropagation(); if(!selected) return;
    const st=stage.getBoundingClientRect();
    res={
      w: selected.clientWidth/scale, h: selected.clientHeight/scale,
      x: (e.clientX - st.left)/scale, y: (e.clientY - st.top)/scale
    };
    window.addEventListener('pointermove', doResize);
    window.addEventListener('pointerup', stopResize);
  }
  function doResize(e){
    if(!res||!selected) return;
    const st=stage.getBoundingClientRect();
    const cx = (e.clientX - st.left)/scale;
    const cy = (e.clientY - st.top)/scale;
    let w=Math.max(40, res.w + (cx-res.x));
    let h = selected.dataset.type==='text' ? 'auto' : Math.max(40, res.h + (cy-res.y));
    selected.style.width = w+'px'; if(h!=='auto') selected.style.height=h+'px';
  }
  function stopResize(){ res=null; window.removeEventListener('pointermove',doResize); window.removeEventListener('pointerup',stopResize); }

  // editor bubble
  const txt=document.getElementById('txt');
  const fs=document.getElementById('fs');
  const fc=document.getElementById('fc');
  const fontFamily=document.getElementById('fontFamily');
  const stampStyle=document.getElementById('stampStyle');

  function openEditor(el){
    if(el && el.dataset.type==='text'){
      txt.value = el.firstChild.textContent;
      fs.value = parseInt(getComputedStyle(el.firstChild).fontSize);
      fc.value = rgb2hex(getComputedStyle(el.firstChild).color);
      fontFamily.value = getComputedStyle(el.firstChild).fontFamily;
    }
  }
  function rgb2hex(rgb){ const m=rgb.match(/\d+/g); if(!m) return '#000000'; return '#'+m.slice(0,3).map(n=>('0'+parseInt(n).toString(16)).slice(-2)).join(''); }
  txt.addEventListener('input', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.textContent = txt.value; });
  fs.addEventListener('input', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.style.fontSize = fs.value+'px'; });
  fc.addEventListener('input', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.style.color = fc.value; });
  fontFamily.addEventListener('change', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.style.fontFamily = fontFamily.value; });
  stampStyle.addEventListener('click', ()=>{ if(selected && selected.dataset.type==='text') selected.firstChild.classList.toggle('stamp'); });

  // add buttons
  document.getElementById('addText').onclick = ()=> mkEl('text',{x:80,y:80});
  document.getElementById('addLogo').onclick = ()=> mkEl('asset',{src:ASSETS.logo,w:220});
  document.getElementById('addStamp').onclick = ()=> mkEl('asset',{src:ASSETS.stampImg,w:480});
  document.getElementById('addMascot').onclick = ()=> mkEl('asset',{src:ASSETS.mascot,w:380});

  // uploads (max 5)
  document.getElementById('uploader').addEventListener('change', e=>{
    const files=[...e.target.files];
    for(const file of files){
      if(uploadCount>=5){ alert('Max 5 uploads reached'); break; }
      const url = URL.createObjectURL(file);
      const el = mkEl('img',{src:url,w:520});
      el.dataset.upload='1'; uploadCount++;
    }
    e.target.value='';
  });

  // arrange
  document.getElementById('front').onclick = ()=>{ if(selected) selected.style.zIndex=++z; };
  document.getElementById('back').onclick = ()=>{ if(selected) selected.style.zIndex=1; };
  document.getElementById('dup').onclick = ()=>{
    if(!selected) return;
    const c=selected.cloneNode(true);
    c.style.left=(parseInt(selected.style.left||'0')+20)+'px';
    c.style.top=(parseInt(selected.style.top||'0')+20)+'px';
    stage.appendChild(c);
    c.querySelector('.handle').addEventListener('pointerdown', startResize);
    c.addEventListener('pointerdown', startDrag);
    select(c);
  };
  document.getElementById('del').onclick = ()=>{ if(selected){ if(selected.dataset.upload==='1') uploadCount=Math.max(0,uploadCount-1); selected.remove(); selected=null; }};
  document.getElementById('clear').onclick = ()=>{ [...stage.querySelectorAll('.el')].forEach(n=>n.remove()); uploadCount=0; selected=null; dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); };

  // size & bg
  document.getElementById('applySize').onclick = ()=>{
    const [w,h] = document.getElementById('sizeSel').value.split('x').map(Number);
    setSize(w,h);
    // default 50% after any size change for clarity
    applyZoom(0.5);
  };
  document.getElementById('bg').oninput = (e)=> stage.style.background = e.target.value;

  // templates (CORS-safe placeholders via placehold.co)
  document.getElementById('blank').onclick = ()=>{ document.getElementById('clear').click(); };
  document.getElementById('tpl').addEventListener('change', e=> loadTpl(e.target.value));

  function ph(w,h,text){ return `https://placehold.co/${w}x${h}?text=${encodeURIComponent(text)}`; }

  function loadTpl(t){
    document.getElementById('clear').click();
    if(t==='beforeAfter'){
      mkEl('text',{x:60,y:40,text:'\"It will never happen\"',size:72});
      mkEl('img',{x:60,y:140,w:700,src:ph(700,600,'BEFORE')});
      mkEl('img',{x:840,y:140,w:700,src:ph(700,600,'AFTER')});
      mkEl('asset',{x:680,y:780,w:260,src:ASSETS.stampImg});
    } else if(t==='reaction'){
      mkEl('text',{x:80,y:80,text:'They said it was dead…',size:96});
      mkEl('asset',{x:1060,y:420,w:380,src:ASSETS.mascot});
      mkEl('asset',{x:80,y:760,w:420,src:ASSETS.stampImg});
    } else if(t==='lieWeek'){
      mkEl('asset',{x:40,y:40,w:160,src:ASSETS.logo});
      mkEl('text',{x:220,y:60,text:'LIE OF THE WEEK',size:96});
      mkEl('img',{x:300,y:220,w:1000,src:ph(1000,520,'Drop Tweet Here')});
      mkEl('asset',{x:590,y:760,w:420,src:ASSETS.stampImg});
    } else if(t==='collage'){
      mkEl('text',{x:60,y:40,text:'Receipts',size:96});
      [[60,160],[840,160],[60,520],[840,520]].forEach((p,i)=> mkEl('img',{x:p[0],y:p[1],w:700,src:ph(700,300,'Receipt '+(i+1))}));
      mkEl('asset',{x:640,y:760,w:320,src:ASSETS.logo});
    } else if(t==='chart'){
      mkEl('text',{x:60,y:60,text:'\"Top is in\" — 2023',size:80});
      mkEl('img',{x:120,y:160,w:1360,src:ph(1360,620,'Chart')});
      mkEl('asset',{x:620,y:760,w:360,src:ASSETS.stampImg});
    } else if(t==='villains'){
      mkEl('text',{x:60,y:40,text:'Top Liars of the Week',size:84});
      [[80,160],[590,160],[1100,160],[80,520],[590,520],[1100,520]].forEach((p,i)=> mkEl('img',{x:p[0],y:p[1],w:420,src:ph(420,420,'#'+(i+1))}));
    } else if(t==='stampOnly'){
      mkEl('asset',{x:550,y:380,w:500,src:ASSETS.stampImg});
    }
  }

  // Draw mode
  let drawing=false, last=null;
  function setDraw(enabled){
    drawing = enabled;
    drawCanvas.style.pointerEvents = enabled ? 'auto' : 'none';
    document.getElementById('drawToggle').textContent = enabled ? 'Disable Draw' : 'Enable Draw';
  }
  setDraw(false);

  drawCanvas.addEventListener('pointerdown', e=>{
    if(!drawing) return;
    const p = getRel(e);
    last = p;
    dctx.strokeStyle = document.getElementById('brushColor').value;
    dctx.lineWidth = document.getElementById('brushSize').value;
    dctx.lineCap = 'round'; dctx.lineJoin='round';
    dctx.beginPath(); dctx.moveTo(p.x, p.y);
    drawCanvas.setPointerCapture(e.pointerId);
  });
  drawCanvas.addEventListener('pointermove', e=>{
    if(!drawing || !last) return;
    const p = getRel(e);
    dctx.lineTo(p.x, p.y); dctx.stroke();
    last = p;
  });
  drawCanvas.addEventListener('pointerup', e=>{
    if(!drawing) return;
    last=null; dctx.closePath(); drawCanvas.releasePointerCapture(e.pointerId);
  });
  function getRel(e){
    const r = drawCanvas.getBoundingClientRect();
    return { x: (e.clientX - r.left)/scale, y: (e.clientY - r.top)/scale };
  }
  document.getElementById('drawToggle').onclick = ()=> setDraw(!drawing);
  document.getElementById('clearDraw').onclick = ()=> dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);

  // Export
  document.getElementById('export').onclick = async ()=>{
    const w = drawCanvas.width, h = drawCanvas.height;
    const out = document.createElement('canvas'); out.width=w; out.height=h; const ctx=out.getContext('2d');
    // bg
    ctx.fillStyle = getComputedStyle(stage).backgroundColor; ctx.fillRect(0,0,w,h);
    // elements
    const els=[...stage.querySelectorAll('.el')].sort((a,b)=> (parseInt(getComputedStyle(a).zIndex)||0)-(parseInt(getComputedStyle(b).zIndex)||0));
    for(const el of els){
      const x=parseFloat(el.style.left)||0, y=parseFloat(el.style.top)||0, width=el.clientWidth, height=el.clientHeight;
      if(el.dataset.type==='img' || el.dataset.type==='asset'){
        const img=el.querySelector('img');
        await drawImage(ctx, img, x, y, width, height);
      } else if(el.dataset.type==='text'){
        const box=el.firstChild; const st=getComputedStyle(box); const isStamp=box.classList.contains('stamp');
        if(isStamp){
          ctx.fillStyle=getComputedStyle(stage).getPropertyValue('--brand')||'#ca3028';
          roundRect(ctx,x,y,box.offsetWidth+24,box.offsetHeight+12,8); ctx.fill();
          ctx.fillStyle='#fff'; ctx.font=`900 ${parseInt(st.fontSize)}px ${st.fontFamily}`; ctx.textBaseline='top';
          ctx.fillText(box.textContent, x+12, y+6);
        } else {
          ctx.fillStyle=st.color; ctx.font=`900 ${parseInt(st.fontSize)}px ${st.fontFamily}`; ctx.textBaseline='top';
          wrapText(ctx, box.textContent, x, y, box.offsetWidth, parseInt(st.fontSize)*1.05);
        }
      }
    }
    // draw the freehand layer
    ctx.drawImage(drawCanvas, 0, 0);

    try{
      const url = out.toDataURL("image/png");
      const a=document.createElement('a'); a.href=url; a.download='they_lied_meme.png'; a.click();
    }catch(err){
      alert('Export blocked (CORS). If you used external images from a host without CORS, try uploading them via the Upload button.');
    }
  };

  function drawImage(ctx,img,x,y,w,h){
    return new Promise(res=>{
      if(img.complete){ safe(); } else { img.onload = safe; img.onerror = res; }
      function safe(){ try{ ctx.drawImage(img,x,y,w,h); }catch{} res(); }
    });
  }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function wrapText(ctx, text, x, y, maxWidth, lh){ const words=text.split(' '); let line=''; for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; if(ctx.measureText(test).width>maxWidth && n>0){ ctx.fillText(line,x,y); line=words[n]+' '; y+=lh; } else { line=test; } } ctx.fillText(line,x,y); }

})();
</script>
</body>
</html>
